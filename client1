<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>r/Infini Multiplayer</title>
<style>
canvas { border:1px solid #000; display:block; margin:auto; }
#palette { text-align:center; margin-top:5px; }
.color { display:inline-block; width:30px; height:30px; margin:2px; border:1px solid #333; cursor:pointer; }
</style>
</head>
<body>
<canvas id="canvas" width="800" height="600"></canvas>
<div id="palette"></div>

<script>
const PALETTE = [
'#FFFFFF','#E4E4E4','#888888','#222222','#FFA7D1','#E50000',
'#E59500','#A06A42','#E5D900','#94E044','#02BE01','#00D3DD',
'#0083C7','#0000EA','#CF6EE4','#820080'
];

let currentColor = PALETTE[1];
let pixels = {};
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const ws = new WebSocket('ws://'+location.hostname+':8765');
ws.onmessage = e => {
    const data = JSON.parse(e.data);
    Object.assign(pixels,data);
    draw();
};

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let key in pixels){
        const [x,y]=key.split(',').map(Number);
        ctx.fillStyle = pixels[key];
        ctx.fillRect(x*20, y*20, 20,20);
    }
}

// Palette
const paletteDiv = document.getElementById('palette');
PALETTE.forEach(color=>{
    const div = document.createElement('div');
    div.className='color'; div.style.background=color;
    div.onclick = ()=>{currentColor=color;}
    paletteDiv.appendChild(div);
});

// Place pixels
canvas.addEventListener('click',e=>{
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX-rect.left)/20);
    const y = Math.floor((e.clientY-rect.top)/20);
    pixels[`${x},${y}`] = currentColor;
    ws.send(JSON.stringify({[`${x},${y}`]: currentColor}));
    draw();
});
</script>
</body>
</html>
